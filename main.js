/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var M=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var Q=(s,n)=>{for(var e in n)M(s,e,{get:n[e],enumerable:!0})},K=(s,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let l of Z(n))!G.call(s,l)&&l!==e&&M(s,l,{get:()=>n[l],enumerable:!(t=X(n,l))||t.enumerable});return s};var _=s=>K(M({},"__esModule",{value:!0}),s);var se={};Q(se,{default:()=>N});module.exports=_(se);var v=require("obsidian");function F(){}F.prototype={diff:function(n,e){var t,l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=l.callback;typeof l=="function"&&(i=l,l={}),this.options=l;var r=this;function a(g){return i?(setTimeout(function(){i(void 0,g)},0),!0):g}n=this.castInput(n),e=this.castInput(e),n=this.removeEmpty(this.tokenize(n)),e=this.removeEmpty(this.tokenize(e));var f=e.length,o=n.length,p=1,h=f+o;l.maxEditLength&&(h=Math.min(h,l.maxEditLength));var m=(t=l.timeout)!==null&&t!==void 0?t:1/0,c=Date.now()+m,u=[{oldPos:-1,lastComponent:void 0}],d=this.extractCommon(u[0],e,n,0);if(u[0].oldPos+1>=o&&d+1>=f)return a([{value:this.join(e),count:e.length}]);var w=-1/0,y=1/0;function x(){for(var g=Math.max(w,-p);g<=Math.min(y,p);g+=2){var C=void 0,T=u[g-1],b=u[g+1];T&&(u[g-1]=void 0);var A=!1;if(b){var j=b.oldPos-g;A=b&&0<=j&&j<f}var R=T&&T.oldPos+1<o;if(!A&&!R){u[g]=void 0;continue}if(!R||A&&T.oldPos+1<b.oldPos?C=r.addToPath(b,!0,void 0,0):C=r.addToPath(T,void 0,!0,1),d=r.extractCommon(C,e,n,g),C.oldPos+1>=o&&d+1>=f)return a(ee(r,C.lastComponent,e,n,r.useLongestToken));u[g]=C,C.oldPos+1>=o&&(y=Math.min(y,g-1)),d+1>=f&&(w=Math.max(w,g+1))}p++}if(i)(function g(){setTimeout(function(){if(p>h||Date.now()>c)return i();x()||g()},0)})();else for(;p<=h&&Date.now()<=c;){var L=x();if(L)return L}},addToPath:function(n,e,t,l){var i=n.lastComponent;return i&&i.added===e&&i.removed===t?{oldPos:n.oldPos+l,lastComponent:{count:i.count+1,added:e,removed:t,previousComponent:i.previousComponent}}:{oldPos:n.oldPos+l,lastComponent:{count:1,added:e,removed:t,previousComponent:i}}},extractCommon:function(n,e,t,l){for(var i=e.length,r=t.length,a=n.oldPos,f=a-l,o=0;f+1<i&&a+1<r&&this.equals(e[f+1],t[a+1]);)f++,a++,o++;return o&&(n.lastComponent={count:o,previousComponent:n.lastComponent}),n.oldPos=a,f},equals:function(n,e){return this.options.comparator?this.options.comparator(n,e):n===e||this.options.ignoreCase&&n.toLowerCase()===e.toLowerCase()},removeEmpty:function(n){for(var e=[],t=0;t<n.length;t++)n[t]&&e.push(n[t]);return e},castInput:function(n){return n},tokenize:function(n){return n.split("")},join:function(n){return n.join("")}};function ee(s,n,e,t,l){for(var i=[],r;n;)i.push(n),r=n.previousComponent,delete n.previousComponent,n=r;i.reverse();for(var a=0,f=i.length,o=0,p=0;a<f;a++){var h=i[a];if(h.removed){if(h.value=s.join(t.slice(p,p+h.count)),p+=h.count,a&&i[a-1].added){var c=i[a-1];i[a-1]=i[a],i[a]=c}}else{if(!h.added&&l){var m=e.slice(o,o+h.count);m=m.map(function(d,w){var y=t[p+w];return y.length>d.length?y:d}),h.value=s.join(m)}else h.value=s.join(e.slice(o,o+h.count));o+=h.count,h.added||(p+=h.count)}}var u=i[f-1];return f>1&&typeof u.value=="string"&&(u.added||u.removed)&&s.equals("",u.value)&&(i[f-2].value+=u.value,i.pop()),i}var te=new F;function I(s,n,e){return te.diff(s,n,e)}var J=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,U=/\S/,Y=new F;Y.equals=function(s,n){return this.options.ignoreCase&&(s=s.toLowerCase(),n=n.toLowerCase()),s===n||this.options.ignoreWhitespace&&!U.test(s)&&!U.test(n)};Y.tokenize=function(s){for(var n=s.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),e=0;e<n.length-1;e++)!n[e+1]&&n[e+2]&&J.test(n[e])&&J.test(n[e+2])&&(n[e]+=n[e+2],n.splice(e+1,2),e--);return n};var V=new F;V.tokenize=function(s){this.options.stripTrailingCr&&(s=s.replace(/\r\n/g,`
`));var n=[],e=s.split(/(\n|\r\n)/);e[e.length-1]||e.pop();for(var t=0;t<e.length;t++){var l=e[t];t%2&&!this.options.newlineIsToken?n[n.length-1]+=l:(this.options.ignoreWhitespace&&(l=l.trim()),n.push(l))}return n};function z(s,n,e){return V.diff(s,n,e)}var ne=new F;ne.tokenize=function(s){return s.split(/(\S.+?[.!?])(?=\s+|$)/)};var ie=new F;ie.tokenize=function(s){return s.split(/([{}:;,]|\s+)/)};function E(s){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?E=function(n){return typeof n}:E=function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},E(s)}var le=Object.prototype.toString,D=new F;D.useLongestToken=!0;D.tokenize=V.tokenize;D.castInput=function(s){var n=this.options,e=n.undefinedReplacement,t=n.stringifyReplacer,l=t===void 0?function(i,r){return typeof r=="undefined"?e:r}:t;return typeof s=="string"?s:JSON.stringify(O(s,null,null,l),l,"  ")};D.equals=function(s,n){return F.prototype.equals.call(D,s.replace(/,([\r\n])/g,"$1"),n.replace(/,([\r\n])/g,"$1"))};function O(s,n,e,t,l){n=n||[],e=e||[],t&&(s=t(l,s));var i;for(i=0;i<n.length;i+=1)if(n[i]===s)return e[i];var r;if(le.call(s)==="[object Array]"){for(n.push(s),r=new Array(s.length),e.push(r),i=0;i<s.length;i+=1)r[i]=O(s[i],n,e,t,l);return n.pop(),e.pop(),r}if(s&&s.toJSON&&(s=s.toJSON()),E(s)==="object"&&s!==null){n.push(s),r={},e.push(r);var a=[],f;for(f in s)s.hasOwnProperty(f)&&a.push(f);for(a.sort(),i=0;i<a.length;i+=1)f=a[i],r[f]=O(s[f],n,e,t,f);n.pop(),e.pop()}else r=s;return r}var $=new F;$.tokenize=function(s){return s.slice()};$.join=$.removeEmpty=function(s){return s};var k="file-diff-view",W="multi-file-diff-view",S=class extends v.FuzzySuggestModal{constructor(e,t,l){super(e);this.onChoose=t,this.excludeFile=l,this.setPlaceholder("\u9009\u62E9\u8981\u6BD4\u8F83\u7684\u6587\u4EF6...")}getItems(){return this.app.vault.getMarkdownFiles().filter(e=>e!==this.excludeFile).sort((e,t)=>e.path.localeCompare(t.path))}getItemText(e){return e.path}onChooseItem(e,t){this.onChoose(e)}},H=class extends v.Modal{constructor(e,t,l,i){super(e);this.title=t,this.message=l,this.onConfirm=i}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:this.title}),e.createEl("p",{text:this.message});let t=e.createDiv({cls:"modal-button-container"});t.style.display="flex",t.style.justifyContent="flex-end",t.style.gap="8px",t.style.marginTop="20px",t.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>{this.onConfirm(!1),this.close()}),t.createEl("button",{text:"\u786E\u8BA4\u5220\u9664",cls:"mod-warning"}).addEventListener("click",()=>{this.onConfirm(!0),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},P=class extends v.ItemView{constructor(e){super(e);this.file1=null;this.file2=null;this.content1="";this.content2=""}getViewType(){return k}getDisplayText(){return this.file1&&this.file2?`Diff: ${this.file1.basename} \u2194 ${this.file2.basename}`:"File Diff"}getIcon(){return"git-compare"}async setFiles(e,t){this.file1=e,this.file2=t,this.content1=await this.app.vault.read(e),this.content2=await this.app.vault.read(t),this.render()}async deleteFile(e,t){if(!e)return;if(await this.showConfirmDialog(`\u786E\u8BA4\u5220\u9664${t}`,`\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6 "${e.path}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002`))try{await this.app.vault.delete(e),this.leaf.detach()}catch(i){new v.Notice(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${i.message}`,5e3),console.error("\u5220\u9664\u6587\u4EF6\u5931\u8D25:",i)}}showConfirmDialog(e,t){return new Promise(l=>{new H(this.app,e,t,l).open()})}render(){var c,u;let e=this.containerEl.children[1];e.empty(),e.addClass("diff-view-container");let t=e.createDiv({cls:"diff-header"}),l=t.createDiv({cls:"diff-file-info diff-file-old"});l.createSpan({cls:"diff-file-label",text:"\u6587\u4EF6\u4E00\uFF08\u5DE6\uFF09: "}),l.createSpan({cls:"diff-file-name",text:((c=this.file1)==null?void 0:c.path)||""});let i=l.createSpan({cls:"diff-file-delete clickable-icon"});i.setAttribute("aria-label","\u5220\u9664\u6587\u4EF6\u4E00"),i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',i.addEventListener("click",async()=>{await this.deleteFile(this.file1,"\u6587\u4EF6\u4E00")});let r=t.createDiv({cls:"diff-file-info diff-file-new"});r.createSpan({cls:"diff-file-label",text:"\u6587\u4EF6\u4E8C\uFF08\u53F3\uFF09: "}),r.createSpan({cls:"diff-file-name",text:((u=this.file2)==null?void 0:u.path)||""});let a=r.createSpan({cls:"diff-file-delete clickable-icon"});a.setAttribute("aria-label","\u5220\u9664\u6587\u4EF6\u4E8C"),a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',a.addEventListener("click",async()=>{await this.deleteFile(this.file2,"\u6587\u4EF6\u4E8C")});let f=this.calculateStats(),o=t.createDiv({cls:"diff-stats"});if(o.createSpan({cls:"diff-stat-add",text:`+${f.additions}`}),o.createSpan({cls:"diff-stat-del",text:`-${f.deletions}`}),!z(this.content1,this.content2).some(d=>d.added||d.removed)){e.createDiv({cls:"diff-no-change"}).setText("\u4E24\u4E2A\u6587\u4EF6\u5185\u5BB9\u76F8\u540C\uFF0C\u6CA1\u6709\u5DEE\u5F02");return}let m=e.createDiv({cls:"diff-content-split"});this.renderSplitDiff(m)}calculateStats(){let e=I(this.content1,this.content2),t=0,l=0;return e.forEach(i=>{i.added?t+=i.value.length:i.removed&&(l+=i.value.length)}),{additions:t,deletions:l}}renderSplitDiff(e){let t=this.content1.split(`
`),l=this.content2.split(`
`),i=z(this.content1,this.content2),r=[],a=0,f=0;i.forEach(c=>{let u=c.value.split(`
`);u[u.length-1]===""&&u.pop(),c.added?u.forEach(d=>{r.push({left:null,right:d,type:"added"}),f++}):c.removed?u.forEach(d=>{r.push({left:d,right:null,type:"removed"}),a++}):u.forEach(d=>{r.push({left:d,right:d,type:"same"}),a++,f++})});let o=[],p=0;for(;p<r.length;){let c=r[p];if(c.type==="removed"){let u=[c.left],d=p+1;for(;d<r.length&&r[d].type==="removed";)u.push(r[d].left),d++;let w=[];for(;d<r.length&&r[d].type==="added";)w.push(r[d].right),d++;let y=Math.max(u.length,w.length);for(let x=0;x<y;x++){let L=x<u.length?u[x]:null,g=x<w.length?w[x]:null;L!==null&&g!==null?o.push({left:L,right:g,type:"modified"}):L!==null?o.push({left:L,right:null,type:"removed"}):g!==null&&o.push({left:null,right:g,type:"added"})}p=d}else o.push(c),p++}let h=1,m=1;o.forEach(c=>{let u=e.createDiv({cls:"diff-row"}),d=u.createDiv({cls:"diff-col diff-col-left"});if(c.left!==null){c.type==="removed"?d.addClass("diff-line-del"):c.type==="modified"&&d.addClass("diff-line-modified-old"),d.createSpan({cls:"diff-line-num",text:String(h++)});let y=d.createSpan({cls:"diff-line-content"});c.type==="modified"&&c.right!==null?this.renderCharDiff(y,c.left,c.right,"old"):y.setText(c.left||" ")}else d.addClass("diff-line-empty"),d.createSpan({cls:"diff-line-num",text:""}),d.createSpan({cls:"diff-line-content",text:" "});let w=u.createDiv({cls:"diff-col diff-col-right"});if(c.right!==null){c.type==="added"?w.addClass("diff-line-add"):c.type==="modified"&&w.addClass("diff-line-modified-new"),w.createSpan({cls:"diff-line-num",text:String(m++)});let y=w.createSpan({cls:"diff-line-content"});c.type==="modified"&&c.left!==null?this.renderCharDiff(y,c.left,c.right,"new"):y.setText(c.right||" ")}else w.addClass("diff-line-empty"),w.createSpan({cls:"diff-line-num",text:""}),w.createSpan({cls:"diff-line-content",text:" "})})}renderCharDiff(e,t,l,i){I(t,l).forEach(a=>{if(i==="old")if(a.removed){let f=e.createSpan({cls:"diff-char-del",text:a.value})}else a.added||e.createSpan({text:a.value});else if(a.added){let f=e.createSpan({cls:"diff-char-add",text:a.value})}else a.removed||e.createSpan({text:a.value})}),e.textContent===""&&e.setText(" ")}async onOpen(){}async onClose(){}},B=class extends v.ItemView{constructor(e){super(e);this.files=[];this.contents=[]}getViewType(){return W}getDisplayText(){return this.files.length>0?`Diff: ${this.files.map(e=>e.basename).join(" \u2194 ")}`:"Multi File Diff"}getIcon(){return"git-compare"}async setFiles(e){this.files=e,this.contents=await Promise.all(e.map(t=>this.app.vault.read(t))),this.render()}async deleteFile(e,t){if(await this.showConfirmDialog(`\u786E\u8BA4\u5220\u9664\u6587\u4EF6${t+1}`,`\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6 "${e.path}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002`))try{await this.app.vault.delete(e),this.files.splice(t,1),this.contents.splice(t,1),this.files.length>=2?(this.render(),new v.Notice(`\u5DF2\u5220\u9664\u6587\u4EF6\uFF0C\u7EE7\u7EED\u5BF9\u6BD4\u5269\u4F59 ${this.files.length} \u4E2A\u6587\u4EF6`)):this.leaf.detach()}catch(i){new v.Notice(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${i.message}`,5e3)}}showConfirmDialog(e,t){return new Promise(l=>{new H(this.app,e,t,l).open()})}render(){let e=this.containerEl.children[1];e.empty(),e.addClass("diff-view-container"),e.addClass("multi-diff-view");let t=e.createDiv({cls:"diff-header multi-diff-header"});if(this.files.forEach((r,a)=>{let f=t.createDiv({cls:`diff-file-info diff-file-${a}`});f.createSpan({cls:"diff-file-label",text:`\u6587\u4EF6${a+1}: `}),f.createSpan({cls:"diff-file-name",text:r.path});let o=f.createSpan({cls:"diff-file-delete clickable-icon"});o.setAttribute("aria-label",`\u5220\u9664\u6587\u4EF6${a+1}`),o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',o.addEventListener("click",()=>this.deleteFile(r,a))}),this.contents.every(r=>r===this.contents[0])){e.createDiv({cls:"diff-no-change"}).setText(`${this.files.length}\u4E2A\u6587\u4EF6\u5185\u5BB9\u76F8\u540C\uFF0C\u6CA1\u6709\u5DEE\u5F02`);return}let i=e.createDiv({cls:"diff-content-split multi-diff-content"});i.style.setProperty("--column-count",String(this.files.length)),this.renderMultiDiff(i)}renderMultiDiff(e){let t=this.contents.map(i=>i.split(`
`)),l=Math.max(...t.map(i=>i.length));for(let i=0;i<l;i++){let r=e.createDiv({cls:"diff-row"}),a=t.map(p=>{var h;return(h=p[i])!=null?h:null}),f=a.filter(p=>p!==null),o=f.length>0&&!f.every(p=>p===f[0]);a.forEach((p,h)=>{let m=r.createDiv({cls:"diff-col"});if(p!==null){if(o){let u=a.filter(d=>d===p).length;u===1?m.addClass("diff-line-unique"):u<this.files.length&&m.addClass("diff-line-partial")}m.createSpan({cls:"diff-line-num",text:String(i+1)});let c=m.createSpan({cls:"diff-line-content"});o&&f.length>1?this.renderCharDiffMulti(c,p,a,h):c.setText(p||" ")}else m.addClass("diff-line-empty"),m.createSpan({cls:"diff-line-num",text:""}),m.createSpan({cls:"diff-line-content",text:" "})})}}renderCharDiffMulti(e,t,l,i){let r=l.filter((o,p)=>o!==null&&p!==i);if(r.length===0){e.setText(t||" ");return}let a=r.find(o=>o!==t)||r[0];I(a,t).forEach(o=>{o.added?e.createSpan({cls:"diff-char-add",text:o.value}):o.removed||e.createSpan({text:o.value})}),e.textContent===""&&e.setText(" ")}async onOpen(){}async onClose(){}},q=class extends v.Modal{constructor(e,t,l,i){super(e);this.selectedFiles=new Set;this.currentFile=t,this.similarFiles=l,this.onConfirm=i,this.selectedFiles.add(t)}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("similar-files-modal"),e.createEl("h2",{text:"\u67E5\u627E\u5230\u76F8\u4F3C\u6587\u4EF6"}),e.createEl("p",{text:`\u5F53\u524D\u6587\u4EF6: ${this.currentFile.basename}`}),e.createEl("p",{cls:"similar-files-hint",text:"\u8BF7\u9009\u62E9\u8981\u5BF9\u6BD4\u7684\u6587\u4EF6\uFF08\u6700\u591A\u9009\u62E93\u4E2A\uFF09:"});let t=e.createDiv({cls:"similar-files-list"}),l=t.createDiv({cls:"similar-file-item current-file"}),i=l.createEl("input",{type:"checkbox"});i.checked=!0,i.disabled=!0,l.createSpan({text:`${this.currentFile.path} (\u5F53\u524D\u6587\u4EF6)`}),this.similarFiles.forEach((o,p)=>{let h=t.createDiv({cls:"similar-file-item"}),m=h.createEl("input",{type:"checkbox"});p<2&&(m.checked=!0,this.selectedFiles.add(o)),m.addEventListener("change",()=>{if(m.checked){if(this.selectedFiles.size>=3){m.checked=!1,new v.Notice("\u6700\u591A\u53EA\u80FD\u9009\u62E93\u4E2A\u6587\u4EF6\u8FDB\u884C\u5BF9\u6BD4");return}this.selectedFiles.add(o)}else this.selectedFiles.delete(o)}),h.createSpan({text:o.path})});let r=e.createDiv({cls:"modal-button-container"});r.style.display="flex",r.style.justifyContent="flex-end",r.style.gap="8px",r.style.marginTop="20px",r.createEl("button",{text:"\u53D6\u6D88"}).addEventListener("click",()=>this.close()),r.createEl("button",{text:"\u5F00\u59CB\u5BF9\u6BD4",cls:"mod-cta"}).addEventListener("click",()=>{if(this.selectedFiles.size<2){new v.Notice("\u8BF7\u81F3\u5C11\u9009\u62E92\u4E2A\u6587\u4EF6\u8FDB\u884C\u5BF9\u6BD4");return}this.onConfirm(Array.from(this.selectedFiles)),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},N=class extends v.Plugin{constructor(){super(...arguments);this.selectedFile=null}async onload(){console.log("File Diff Plugin loaded"),this.registerView(k,e=>new P(e)),this.registerView(W,e=>new B(e)),this.registerEvent(this.app.workspace.on("files-menu",(e,t)=>{let l=t.filter(i=>i instanceof v.TFile&&i.extension==="md");l.length===2&&e.addItem(i=>{i.setTitle("Diff: \u5BF9\u6BD4\u9009\u4E2D\u7684\u4E24\u4E2A\u6587\u4EF6").setIcon("git-compare").onClick(async()=>{await this.openDiffView(l[0],l[1])})})})),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof v.TFile&&t.extension==="md"&&(this.selectedFile?(e.addItem(l=>{var i;l.setTitle(`Diff: \u4E0E "${(i=this.selectedFile)==null?void 0:i.basename}" \u6BD4\u8F83`).setIcon("git-compare").onClick(async()=>{this.selectedFile&&(await this.openDiffView(this.selectedFile,t),this.selectedFile=null)})}),e.addItem(l=>{l.setTitle("Diff: \u91CD\u65B0\u8BBE\u4E3A\u6BD4\u8F83\u6E90").setIcon("refresh-cw").onClick(()=>{this.selectedFile=t,new v.Notice(`\u5DF2\u66F4\u65B0\u6BD4\u8F83\u6E90\u4E3A "${t.basename}"`)})}),e.addItem(l=>{l.setTitle("Diff: \u6E05\u9664\u6BD4\u8F83\u6E90").setIcon("x").onClick(()=>{this.selectedFile=null,new v.Notice("\u5DF2\u6E05\u9664\u6BD4\u8F83\u6E90")})})):e.addItem(l=>{l.setTitle("Diff: \u8BBE\u4E3A\u6BD4\u8F83\u6E90").setIcon("git-compare").onClick(()=>{this.selectedFile=t,new v.Notice(`\u5DF2\u9009\u62E9 "${t.basename}" \u4F5C\u4E3A\u6BD4\u8F83\u6E90`)})}))})),this.addCommand({id:"compare-two-files",name:"\u6BD4\u8F83\u4E24\u4E2A\u6587\u4EF6",callback:()=>{this.selectAndCompareFiles()}}),this.addCommand({id:"compare-with-current",name:"\u9009\u62E9\u6587\u4EF6\u4E0E\u5F53\u524D\u6587\u4EF6\u6BD4\u8F83",checkCallback:e=>{let t=this.app.workspace.getActiveFile();return t&&t.extension==="md"?(e||new S(this.app,async l=>{await this.openDiffView(t,l)},t).open(),!0):!1}}),this.addCommand({id:"clear-diff-source",name:"\u6E05\u9664\u6BD4\u8F83\u6E90",callback:()=>{this.selectedFile=null,new v.Notice("\u5DF2\u6E05\u9664\u6BD4\u8F83\u6E90")}}),this.addCommand({id:"find-similar-files-and-diff",name:"\u67E5\u627E\u76F8\u4F3C\u6587\u4EF6\u540D\u5E76\u5BF9\u6BD4",checkCallback:e=>{let t=this.app.workspace.getActiveFile();return t&&t.extension==="md"?(e||this.findSimilarFilesAndDiff(t),!0):!1}})}findSimilarFilesAndDiff(e){let t=e.basename,i=this.app.vault.getMarkdownFiles().filter(r=>r.path===e.path?!1:!!(r.basename===t||r.basename.includes(t)));if(i.length===0){new v.Notice(`\u672A\u627E\u5230\u4E0E "${t}" \u76F8\u4F3C\u7684\u6587\u4EF6`);return}new q(this.app,e,i,async r=>{await navigator.clipboard.writeText(e.name),new v.Notice(`\u5DF2\u590D\u5236\u6587\u4EF6\u540D: ${e.name}`),r.length===2?await this.openDiffView(r[0],r[1]):r.length===3&&await this.openMultiDiffView(r)}).open()}async openMultiDiffView(e){let t=this.app.workspace.openPopoutLeaf();await t.setViewState({type:W,active:!0}),await t.view.setFiles(e)}async selectAndCompareFiles(){new S(this.app,e=>{new S(this.app,async t=>{await this.openDiffView(e,t)},e).open()}).open()}async openDiffView(e,t){let l=this.app.workspace.openPopoutLeaf();await l.setViewState({type:k,active:!0}),await l.view.setFiles(e,t)}onunload(){console.log("File Diff Plugin unloaded"),this.selectedFile=null}};
